From 6f08da7cb423f9e4f9c0afeeaa7057acf327700c Mon Sep 17 00:00:00 2001
From: Amar Singhal <asinghal@codeaurora.org>
Date: Thu, 12 Sep 2013 14:07:01 -0700
Subject: [PATCH 2/2] wlan: Fix race conditions when configuring arp filter

Change-Id: Iaaa366cb9cea5137e1c26d9fa7707b3dc6c28910
---
 CORE/HDD/inc/wlan_hdd_main.h          | 2 ++
 CORE/HDD/src/wlan_hdd_assoc.c         | 1 +
 CORE/HDD/src/wlan_hdd_early_suspend.c | 9 ++++++---
 3 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/CORE/HDD/inc/wlan_hdd_main.h b/CORE/HDD/inc/wlan_hdd_main.h
index f56795e..33b79fa 100644
--- a/CORE/HDD/inc/wlan_hdd_main.h
+++ b/CORE/HDD/inc/wlan_hdd_main.h
@@ -1027,6 +1027,8 @@ struct hdd_context_s
 
     v_U8_t sus_res_mcastbcast_filter;
 
+    v_BOOL_t sus_res_mcastbcast_filter_valid;
+
     vos_timer_t hdd_p2p_go_conn_is_in_progress;
 
 #ifdef FEATURE_WLAN_LPHB
diff --git a/CORE/HDD/src/wlan_hdd_assoc.c b/CORE/HDD/src/wlan_hdd_assoc.c
index e4e3d16..b9519ed 100644
--- a/CORE/HDD/src/wlan_hdd_assoc.c
+++ b/CORE/HDD/src/wlan_hdd_assoc.c
@@ -2463,6 +2463,7 @@ eHalStatus hdd_smeRoamCallback( void *pContext, tCsrRoamInfo *pRoamInfo, tANI_U3
                     hdd_conf_mcastbcast_filter(pHddCtx, FALSE);
                     pHddCtx->configuredMcastBcastFilter =
                         pHddCtx->sus_res_mcastbcast_filter;
+		    pHddCtx->sus_res_mcastbcast_filter = VOS_FALSE;
 
                     (WLAN_HDD_GET_CTX(pAdapter))->hdd_mcastbcast_filter_set = FALSE;
                 }
diff --git a/CORE/HDD/src/wlan_hdd_early_suspend.c b/CORE/HDD/src/wlan_hdd_early_suspend.c
index 4c04be3..010f430 100644
--- a/CORE/HDD/src/wlan_hdd_early_suspend.c
+++ b/CORE/HDD/src/wlan_hdd_early_suspend.c
@@ -714,15 +714,17 @@ VOS_STATUS hdd_conf_arp_offload(hdd_adapter_t *pAdapter, v_BOOL_t fenable)
 
            hddLog(VOS_TRACE_LEVEL_INFO, "%s: Enabled \n", __func__);
 
-           if((HDD_MCASTBCASTFILTER_FILTER_ALL_BROADCAST ==
+           if(((HDD_MCASTBCASTFILTER_FILTER_ALL_BROADCAST ==
               pHddCtx->configuredMcastBcastFilter) ||
               (HDD_MCASTBCASTFILTER_FILTER_ALL_MULTICAST_BROADCAST ==
-              pHddCtx->configuredMcastBcastFilter))
+              pHddCtx->configuredMcastBcastFilter)) &&
+	      (pHddCtx->sus_res_mcastbcast_filter == VOS_FALSE))
            {
                offLoadRequest.enableOrDisable =
                SIR_OFFLOAD_ARP_AND_BCAST_FILTER_ENABLE;
+	       pHddCtx->sus_res_mcastbcast_filter = VOS_TRUE;
            }
-           
+
            //converting u32 to IPV4 address
            for(i = 0 ; i < 4; i++)
            {
@@ -918,6 +920,7 @@ static void hdd_conf_resume_ind(hdd_adapter_t *pAdapter)
 
     pHddCtx->configuredMcastBcastFilter =
       pHddCtx->sus_res_mcastbcast_filter;
+    pHddCtx->sus_res_mcastbcast_filter_valid = VOS_FALSE;
 
 
 #ifdef WLAN_FEATURE_PACKET_FILTERING
-- 
1.8.2.1

