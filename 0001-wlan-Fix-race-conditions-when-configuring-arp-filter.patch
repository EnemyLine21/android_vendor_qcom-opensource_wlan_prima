From 53dc8e7fab89815e3f41c2fb53fe1d9b0865eda0 Mon Sep 17 00:00:00 2001
From: Amar Singhal <asinghal@codeaurora.org>
Date: Thu, 12 Sep 2013 14:07:01 -0700
Subject: [PATCH] wlan: Fix race conditions when configuring arp filter

Change-Id: Iaaa366cb9cea5137e1c26d9fa7707b3dc6c28910
---
 CORE/HDD/inc/wlan_hdd_main.h          |  2 ++
 CORE/HDD/src/wlan_hdd_assoc.c         |  3 +++
 CORE/HDD/src/wlan_hdd_early_suspend.c | 20 +++++++++++++++++---
 3 files changed, 22 insertions(+), 3 deletions(-)

diff --git a/CORE/HDD/inc/wlan_hdd_main.h b/CORE/HDD/inc/wlan_hdd_main.h
index 63ea8b2..8741e23 100644
--- a/CORE/HDD/inc/wlan_hdd_main.h
+++ b/CORE/HDD/inc/wlan_hdd_main.h
@@ -1036,6 +1036,8 @@ struct hdd_context_s
 
     v_U8_t sus_res_mcastbcast_filter;
 
+    v_BOOL_t sus_res_mcastbcast_filter_valid;
+
     vos_timer_t hdd_p2p_go_conn_is_in_progress;
 
 #ifdef FEATURE_WLAN_LPHB
diff --git a/CORE/HDD/src/wlan_hdd_assoc.c b/CORE/HDD/src/wlan_hdd_assoc.c
index 06d89fa..9e96d3d 100644
--- a/CORE/HDD/src/wlan_hdd_assoc.c
+++ b/CORE/HDD/src/wlan_hdd_assoc.c
@@ -2493,7 +2493,10 @@ eHalStatus hdd_smeRoamCallback( void *pContext, tCsrRoamInfo *pRoamInfo, tANI_U3
                     hdd_conf_mcastbcast_filter(pHddCtx, FALSE);
                     pHddCtx->configuredMcastBcastFilter =
                         pHddCtx->sus_res_mcastbcast_filter;
+		    pHddCtx->sus_res_mcastbcast_filter = VOS_FALSE;
 
+		    printk(" disassociation happening, restoring configuredMcastBcastFilter\n");
+		    printk(" already called mcastbcast filter\n");
                     (WLAN_HDD_GET_CTX(pAdapter))->hdd_mcastbcast_filter_set = FALSE;
                 }
 #ifdef WLAN_FEATURE_PACKET_FILTERING
diff --git a/CORE/HDD/src/wlan_hdd_early_suspend.c b/CORE/HDD/src/wlan_hdd_early_suspend.c
index 57c13b3..54582b0 100644
--- a/CORE/HDD/src/wlan_hdd_early_suspend.c
+++ b/CORE/HDD/src/wlan_hdd_early_suspend.c
@@ -720,15 +720,20 @@ VOS_STATUS hdd_conf_arp_offload(hdd_adapter_t *pAdapter, v_BOOL_t fenable)
 
            hddLog(VOS_TRACE_LEVEL_INFO, "%s: Enabled \n", __func__);
 
-           if((HDD_MCASTBCASTFILTER_FILTER_ALL_BROADCAST ==
+           if(((HDD_MCASTBCASTFILTER_FILTER_ALL_BROADCAST ==
               pHddCtx->configuredMcastBcastFilter) ||
               (HDD_MCASTBCASTFILTER_FILTER_ALL_MULTICAST_BROADCAST ==
-              pHddCtx->configuredMcastBcastFilter))
+              pHddCtx->configuredMcastBcastFilter)) ||
+	      (pHddCtx->sus_res_mcastbcast_filter == VOS_TRUE))
            {
                offLoadRequest.enableOrDisable =
                SIR_OFFLOAD_ARP_AND_BCAST_FILTER_ENABLE;
+	       pHddCtx->sus_res_mcastbcast_filter = VOS_TRUE;
            }
-           
+
+	   printk("arp filter being programmed = %d\n",
+		  offLoadRequest.enableOrDisable);
+
            //converting u32 to IPV4 address
            for(i = 0 ; i < 4; i++)
            {
@@ -857,6 +862,8 @@ static void hdd_conf_suspend_ind(hdd_context_t* pHddCtx,
     pHddCtx->sus_res_mcastbcast_filter =
         pHddCtx->configuredMcastBcastFilter;
 
+    printk(" hdd_conf_suspend_ind, configuredMCastBcastFilter saved\n");
+
     if(NULL == wlanSuspendParam)
     {
         hddLog(VOS_TRACE_LEVEL_FATAL,
@@ -924,6 +931,9 @@ static void hdd_conf_resume_ind(hdd_adapter_t *pAdapter)
 
     pHddCtx->configuredMcastBcastFilter =
       pHddCtx->sus_res_mcastbcast_filter;
+    pHddCtx->sus_res_mcastbcast_filter_valid = VOS_FALSE;
+
+    printk("in hdd_conf_resume_ind, restoring configuredMcastBcastFilter\n");
 
 
 #ifdef WLAN_FEATURE_PACKET_FILTERING
@@ -1089,6 +1099,10 @@ static void hdd_PowerStateChangedCB
    if((newState == BMPS) &&  pHddCtx->hdd_wlan_suspended) {
       spin_unlock(&pHddCtx->filter_lock);
       pHddCtx->sus_res_mcastbcast_filter = pHddCtx->configuredMcastBcastFilter;
+      printk(" power state change callback to associated, saving configuredMcastBcastFilter\n");
+
+      printk(" calling hdd_conf_mcastbcast_filter\n");
+
       hdd_conf_mcastbcast_filter(pHddCtx, TRUE);
       if(pHddCtx->hdd_mcastbcast_filter_set != TRUE)
          hddLog(VOS_TRACE_LEVEL_ERROR, "%s: Not able to set mcast/bcast filter ", __func__);
-- 
1.8.2

